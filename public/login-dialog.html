<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OAuth Login</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #loading {
      font-size: 1.2em;
      color: #2E75B6;
    }
    iframe {
      border: none;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="loading">Loading login...</div>

  <script>
    // Configuration for OAuth provider
    const oauthConfig = {
      authUrl: 'https://accounts.google.com/o/oauth2/v2/auth', // example: Google OAuth 2.0 auth endpoint
      clientId: 'YOUR_CLIENT_ID',
      redirectUri: window.location.origin + '/login-dialog.html', // must be registered with your OAuth provider
      scope: 'openid email profile',
      responseType: 'token', // or 'code' depending on your OAuth flow
      state: 'abc123', // optional random string for security
    };

    function buildAuthUrl() {
      const params = new URLSearchParams({
        client_id: oauthConfig.clientId,
        redirect_uri: oauthConfig.redirectUri,
        response_type: oauthConfig.responseType,
        scope: oauthConfig.scope,
        state: oauthConfig.state,
        prompt: 'select_account', // optional
      });
      return oauthConfig.authUrl + '?' + params.toString();
    }

    // Load OAuth page in iframe inside this page
    const authUrl = buildAuthUrl();
    const loadingDiv = document.getElementById('loading');

    // Create iframe to host OAuth login UI
    const iframe = document.createElement('iframe');
    iframe.src = authUrl;
    iframe.style.width = '100%';
    iframe.style.height = '100vh';
    document.body.appendChild(iframe);
    loadingDiv.style.display = 'none';

    // Listen for messages or URL changes for access token in URL fragment (#access_token=...)
    function checkHash() {
      try {
        const hash = iframe.contentWindow.location.hash;
        if (hash && hash.includes('access_token=')) {
          const params = new URLSearchParams(hash.substr(1));
          const accessToken = params.get('access_token');
          const tokenType = params.get('token_type');
          const expiresIn = params.get('expires_in');
          const state = params.get('state');

          // TODO: optionally validate state

          // Retrieve user info from token (optional, or pass token to parent)
          // For example, decode JWT or call userinfo endpoint here

          // Send token back to parent
          Office.context.ui.messageParent(
            JSON.stringify({ token: accessToken, email: 'user@example.com' /* or fetch real user email */ })
          );

          // Close the dialog after sending message
          Office.context.ui.closeContainer();
        }
      } catch (e) {
        // Cross-origin iframe access error expected until redirect happens to same-origin
      }
    }

    // Poll every 500ms to detect access token
    const interval = setInterval(checkHash, 500);

    // If the OAuth provider redirects back to this same page with access token in URL hash,
    // parse and send it immediately.
    window.onload = () => {
      const hash = window.location.hash;
      if (hash && hash.includes('access_token=')) {
        clearInterval(interval);
        const params = new URLSearchParams(hash.substr(1));
        const accessToken = params.get('access_token');

        Office.context.ui.messageParent(
          JSON.stringify({ token: accessToken, email: 'user@example.com' /* replace with actual user email */ })
        );
        Office.context.ui.closeContainer();
      }
    };
  </script>
</body>
</html>
